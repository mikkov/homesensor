<!DOCTYPE html> 
<html> 
<head> 
    <title>Lämpötila</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"> 	
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0-rc.2/jquery.mobile-1.2.0-rc.2.min.css" />
    <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.2.0-rc.2/jquery.mobile-1.2.0-rc.2.min.js"></script>

    <link rel="stylesheet" type="text/css" href="http://dev.jtsage.com/cdn/datebox/latest/jqm-datebox.min.css" />
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jqm-datebox.core.min.js"></script>
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/latest/jqm-datebox.mode.calbox.min.js"></script>
    <script type="text/javascript" src="http://dev.jtsage.com/cdn/datebox/i18n/jquery.mobile.datebox.i18n.en_US.utf8.js"></script> 
</head> 
<body> 

<div data-role="page" id="mainPage">

    <div data-role="header">
        <a href="#" data-role="button" data-icon="refresh" id="refreshButton">Päivitä</a>
        <h1>Lämpötila</h1>
    </div><!-- /header -->

    <div data-role="content">	
        <ul data-role="listview" id="sensorlist">
        </ul>
    </div>

    <div data-role="footer" class="ui-bar">
    	<a href="#graphPage" data-role="button" data-icon="arrow-r" id="graphButton">Katso</a>
    </div>


</div><!-- /page -->

<div data-role="page" id="graphPage">

    <div data-role="header">
    	<a href="#mainPage" data-role="button" data-icon="arrow-l">Takaisin</a>
        <h1>Lämpötila</h1>
    </div><!-- /header -->

    <div data-role="content">
        <img id="graphContent" src="graph.php">
    </div>

    <div data-role="footer" class="ui-bar">
    	<select name="hours" id="timeSelect">
            <option value="12">12 tuntia</option>
            <option selected value="24">1 päivä</option>
            <option value="72">3 päivää</option>
            <option value="168">1 viikko</option>
            <option value="custom">Tarkemmin...</option>
        </select>
    </div>


</div><!-- /page -->

<div data-role="dialog" id="timeDialog">

    <div data-role="header">
        <h1>Valitse alku- ja loppuaika</h1>
    </div><!-- /header -->

    <div data-role="content">
        <label for="startDate">Alkuaika</label>
        <input name="startDate" id="startDate" type="date" data-role="datebox" data-options='{"mode": "calbox"}'>
        <label for="endDate">Loppuaika</label>
        <input name="endDate" id="endDate" type="date" data-role="datebox" data-options='{"mode": "calbox"}'>
    	<a href="#graphPage" id="dateDialogCloseButton" data-role="button" date-rel="back" data-theme="b">Aseta</a>
    </div>

</div><!-- /dialog -->

<script>
jQuery.extend(jQuery.mobile.datebox.prototype.options, {
    'overrideDateFormat': '%d.%m.%Y',
    'overrideHeaderFormat': '%d.%m.%Y'
});

var sersordata;
var selected_index = [];
$(document).bind("pageinit", function(event) {
    checkboxRefresh();
    
    $("#sensorlist").on("click", ' > li', function(event) {
        if (selected_index[$(this).index()] == true) {
            selected_index[$(this).index()] = false;
            $(this).removeClass("ui-btn-up-b");
            $(this).removeClass("ui-btn-hover-b");
            $(this).addClass("ui-btn-up-a");
            $(this).attr("data-theme", "a");
        }
        else {
            selected_index[$(this).index()] = true;
            $(this).removeClass("ui-btn-up-a");
            $(this).removeClass("ui-btn-hover-a");
            $(this).addClass("ui-btn-up-b");
            $(this).attr("data-theme", "b");
        }
    });
    
    $("#timeSelect").change(function () {
        var selected = $("#timeSelect option:selected").attr("value");
        if (selected == "custom") {
            $.mobile.changePage('#timeDialog', 'pop', true, true);
        } else
            graphRefresh(buildGraphQuery(sensordata, selected_index));
    });

    $("#graphButton").on("click", function(event) {
        graphRefresh(buildGraphQuery(sensordata, selected_index));
    });

    $("#refreshButton").on("click", function(event) {
        checkboxRefresh();
    });
    
    $("#dateDialogCloseButton").on("click", function(event) {
        graphRefresh(buildGraphQuery(sensordata, selected_index));
    });
});

function parseDate(datestring) {
    var datearray = datestring.split(".");
    var date = new Date();
    date.setFullYear(datearray[2]);
    date.setMonth(datearray[1]);
    date.setDate(datearray[0]);
    return date;
}

function checkboxRefresh(){
    $.getJSON('sensor.php', function(data) {
        var items = [];
        var items2 = [];
        $.each(data, function(i,sensor) {
            items2.push('<li data-icon="false" data-theme="a" id="' + sensor.id + '"><a href=#>' + sensor.name +" " + sensor.value + '</a></li>');
            items.push('<input type="checkbox" name="checkbox-'+sensor.id+'" id="checkbox-'+sensor.id+'"class="custom" /><label for="checkbox-'+sensor.id+'">'+sensor.name+' '+sensor.value+'</label>');
        });
        document.getElementById("sensorlist").innerHTML= items2.join('');
        $("#sensorlist").listview("refresh");
        sensordata = data;
    });
}

function graphRefresh(query) {
    $("#graphContent").attr("src", query);
}


function buildGraphQuery(sensors, selected) {
    var graphQuery = "graph.php?fullscreen=1&";
    $.each(sensors, function(i, sensor){
        if (selected[i] == true)
            graphQuery = graphQuery+'sensor[]='+sensor.id+'&';
    });

    var hours = $("#timeSelect option:selected").attr("value")
    if (hours == "custom") {
        var startDate = parseDate($("#startDate").val());
        var endDate = parseDate($("#endDate").val());
        endDate.setDate(endDate.getDate()+1);
        var startDateString = ''+startDate.getFullYear()+'-'+startDate.getMonth()+'-'+startDate.getDate()+'-00-00-00';
        var endDateString = ''+endDate.getFullYear()+'-'+endDate.getMonth()+'-'+endDate.getDate()+'-00-00-00';
        graphQuery = graphQuery+'dateStart='+startDateString+'&dateEnd='+endDateString+'&';
    } else {
        graphQuery = graphQuery+'hours='+hours+'&';
    }

    return graphQuery;
}
</script>

</body>
</html>

